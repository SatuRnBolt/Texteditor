# 单元测试说明

## 概述

本项目使用Python unittest框架实现自动化测试，配合GitHub Actions实现持续集成。

**测试框架**: Python unittest（标准库）  
**依赖**: 无外部依赖  
**CI/CD**: GitHub Actions

---

## 快速开始

```bash
# 运行所有测试
python test_editor_actions.py

# 详细输出
python -m unittest test_editor_actions -v

# 运行特定模块测试
python -m unittest test_editor_actions.TestAppendCommand
```

---

## 测试结构

### 当前测试模块

#### 1. 文本编辑命令测试 (`test_editor_actions.py`)

| 测试类 | 用例数 | 测试内容 |
|--------|--------|---------|
| `TestAppendCommand` | 9 | 追加文本操作、特殊字符、中文支持 |
| `TestInsertCommand` | 10 | 插入文本、空文件处理、多行插入、边界检查 |
| `TestDeleteCommand` | 9 | 删除操作、长度检查、边界条件 |
| `TestReplaceCommand` | 9 | 替换操作、空串处理、长短文本 |
| `TestShowCommand` | 6 | 显示内容、范围查询、空文件处理 |
| `TestUndoRedoIntegration` | 7 | 撤销重做功能、多次操作、混合场景 |
| `TestWorkSpaceUndoRedo` | 2 | 工作区级别命令测试 |

**总计**: 51个测试用例

### 测试覆盖类型

- ✅ **功能测试**: 基本命令功能验证
- ✅ **边界测试**: 空文件、越界、长度限制
- ✅ **错误处理**: 无效参数、错误格式
- ✅ **集成测试**: 命令组合、状态管理
- ✅ **国际化**: 中文、特殊字符支持

---

## 测试文件组织

```
tests/
├── test_editor_actions.py          # 文本编辑命令测试
├── test_workspace.py               # [待添加] 工作区命令测试
├── test_logging.py                 # [待添加] 日志模块测试
└── test_integration.py             # [待添加] 集成测试
```

### 测试基类设计

```python
class TestEditorActionsBase(unittest.TestCase):
    """测试基类 - 提供通用的setUp和tearDown"""
    
    def setUp(self):
        """每个测试前清理环境，确保测试独立性"""
        # 清理全局状态
        # 创建测试文件实例
    
    def tearDown(self):
        """每个测试后清理资源"""
```

所有测试类继承此基类，确保：
- 测试环境隔离
- 状态不相互影响
- 资源正确清理

---

## 添加新测试

### 步骤1: 创建测试文件

```python
# test_new_module.py
import unittest
from test_editor_actions import TestEditorActionsBase

class TestNewFeature(TestEditorActionsBase):
    """新功能测试"""
    
    def test_feature_basic(self):
        """测试基本功能"""
        # Arrange
        # Act
        # Assert
        pass
    
    def test_feature_edge_case(self):
        """测试边界情况"""
        pass
```

### 步骤2: 运行测试

```bash
python -m unittest test_new_module
```

### 步骤3: 更新本文档

在"测试结构"部分添加新模块说明。

---

## 测试命令参考

### 基本运行

```bash
# 运行所有测试
python test_editor_actions.py

# 使用unittest模块运行
python -m unittest discover -s . -p "test_*.py"
```

### 特定测试

```bash
# 运行单个测试文件
python -m unittest test_editor_actions

# 运行单个测试类
python -m unittest test_editor_actions.TestAppendCommand

# 运行单个测试方法
python -m unittest test_editor_actions.TestAppendCommand.test_append_single_line
```

### 输出控制

```bash
# 详细模式 (-v)
python -m unittest test_editor_actions -v

# 安静模式 (-q)
python -m unittest test_editor_actions -q

# 显示局部变量 (失败时)
python -m unittest test_editor_actions --locals
```

---

## GitHub Actions 集成

### 配置文件

`.github/workflows/test.yml`

### 触发条件

- **Push**: 推送到 `main`、`master`、`develop` 分支
- **Pull Request**: 针对上述分支的PR

### 工作流步骤

1. 检出代码仓库
2. 设置Python环境（矩阵版本）
3. 安装项目依赖（如有）
4. 运行所有测试
5. 报告测试结果

### 查看测试结果

1. 进入仓库的 **Actions** 标签
2. 选择 **Run Unit Tests** 工作流
3. 查看各Python版本的测试状态
4. 点击具体运行查看详细日志

---

## 测试示例

### 功能测试示例

```python
def test_append_single_line(self):
    """测试追加单行文本"""
    cmd = EditorActions.AppendCommand()
    result = cmd.execute('append "Hello World"')
    
    self.assertTrue(result)
    self.assertEqual(len(self.test_file.content), 1)
    self.assertEqual(self.test_file.content[0], "Hello World")
    self.assertEqual(self.test_file.state, "modified")
```

### 边界测试示例

```python
def test_insert_in_empty_file_at_invalid_position(self):
    """测试在空文件的非1:1位置插入（应该失败）"""
    cmd = EditorActions.InsertCommand()
    result = cmd.execute('insert 1:2 "Test"')
    
    self.assertFalse(result)
```

### 集成测试示例

```python
def test_mixed_operations_undo_redo(self):
    """测试混合操作的撤销重做"""
    # 执行多个操作
    insert_cmd.execute('insert 1:7 "Beautiful "')
    delete_cmd.execute('delete 1:7 10')
    replace_cmd.execute('replace 1:1 5 "Hi"')
    
    # 依次撤销
    self.test_file.undo()
    self.test_file.undo()
    self.test_file.undo()
    
    # 依次重做
    self.test_file.redo()
    self.test_file.redo()
    self.test_file.redo()
    
    # 验证最终状态
    self.assertEqual(self.test_file.content[0], "Hi World")
```

---

## 测试最佳实践

### 命名规范

- 测试文件: `test_*.py`
- 测试类: `Test<ModuleName>`
- 测试方法: `test_<feature>_<scenario>`

### 测试结构 (AAA模式)

```python
def test_example(self):
    # Arrange - 准备测试数据和环境
    test_data = "example"
    
    # Act - 执行被测试的操作
    result = function_under_test(test_data)
    
    # Assert - 验证结果
    self.assertEqual(result, expected_value)
```

### 测试独立性

- 每个测试独立运行
- 使用setUp/tearDown管理资源
- 不依赖测试执行顺序
- 避免测试间共享状态

### 文档化

- 每个测试方法添加docstring
- 说明测试目的和预期行为
- 复杂逻辑添加注释

---

## 维护指南

### 修改现有代码时

1. 运行相关测试确保未破坏功能
2. 如果行为改变，更新对应测试
3. 提交代码前运行所有测试

### 添加新功能时

1. 同步编写测试用例
2. 覆盖正常场景和边界情况
3. 更新本文档的测试结构部分

### 修复Bug时

1. 先写重现bug的测试（应该失败）
2. 修复代码使测试通过
3. 保留测试防止回归

---

## 技术细节

### 测试框架
- **unittest**: Python标准库，无需安装
- **兼容性**: Python 3.8+
- **断言方法**: 使用unittest标准断言

### 依赖管理
- 使用Python标准库
- 无外部测试依赖
- `requirements.txt` 为项目依赖（非测试依赖）

### 测试隔离
```python
def setUp(self):
    """确保每个测试从干净状态开始"""
    WorkSpace.WorkSpace.current_workFile_path = ""
    WorkSpace.WorkSpace.current_workFile_list = {}
    WorkSpace.WorkSpace.recent_files = []
    File.FileList.all_files_path.clear()
    File.FileList.all_files.clear()
```

---

## 相关文件

```
test_editor_actions.py          # 编辑命令测试实现
requirements.txt                # 项目依赖（测试无额外依赖）
.github/workflows/test.yml      # CI/CD配置
测试说明.md                     # 本文件
```

---

## 扩展计划

### 待添加测试模块

- [ ] **工作区命令测试**: load, save, init, close, edit等
- [ ] **日志模块测试**: log-on, log-off, log-show功能
- [ ] **文件IO测试**: 文件读写、编码处理
- [ ] **集成测试**: 完整使用场景模拟
- [ ] **性能测试**: 大文件、多次操作性能

### 测试工具扩展

- [ ] 代码覆盖率报告 (coverage)
- [ ] 性能基准测试 (pytest-benchmark)
- [ ] 测试报告生成 (HTMLTestRunner)

---

**最后更新**: 2024-11-21  
**当前测试**: 51个用例，覆盖文本编辑命令模块
